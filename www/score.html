<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <!-- <script src="js/app.js"></script> -->
  <script src="lib/onsenui/js/onsenui.min.js"></script>

  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
  <link rel="stylesheet" href="css/style.css">

  <script>
    // Page init event
    // SDKを利用するためのコード(成績保持のために使う)
    var ncmb = new NCMB("ad3da03c7c0dbd222b0e7f0b7d891e9de2f79acda2dd3cdbf606a92687b13af5","e6b5108ec940908467b82b77bbc622e1c67fba5ca4ccc48202672bf769192839");
    var APPLICATION_ID = "Gn00hca1AEsKkkLY";

    document.addEventListener('init', function(event) {
      var page = event.target;

      var resultYayoi = [];
      var resultAsuka = [];
      var resultNara = [];

      if (page.matches('#score-top-page')) {
        var scoreRate = ncmb.DataStore("ScoreRate");
        scoreRate.limit(50)
        .fetchAll()
        .then(function(results){
          // 結果取得後の処理を書いていく。⇒配列に代入する？
          // 全部抜き出す？⇒最新5つ分とすべての平均の％を表示
          for (var i = 0; i < results.length; i++) {
          resultYayoi.push(results[i].yayoi);
          resultAsuka.push(results[i].asuka);
          resultNara.push(results[i].nara);
          // var resultDate = results[i].createDate;
          }

          // 各時代の平均正答率を出す処理↓
          var allYayoiScore = 0;
          for (let i=0; i<resultYayoi.length; i++) {
            allYayoiScore += resultYayoi[i];
          }
          console.log(allYayoiScore);
          
          var yayoiAvg = Math.round(allYayoiScore / resultYayoi.length);

          var allAsukaScore = 0;
          for (let i=0; i<resultAsuka.length; i++) {
            allAsukaScore += resultAsuka[i];
          }
          var asukaAvg = Math.round(allAsukaScore / resultAsuka.length);

          var allNaraScore = 0;
          for (let i=0; i<resultNara.length; i++) {
            allNaraScore += resultNara[i];
          }
          var naraAvg = Math.round(allNaraScore / resultNara.length);
          console.log(naraAvg);

          document.getElementById('yAvg').textContent = yayoiAvg;
          document.getElementById('aAvg').textContent = asukaAvg;
          document.getElementById('nAvg').textContent = naraAvg;
          // 各時代の平均正答率を出す処理↑

          // 各時代の実施回ごとの正答率を出す処理↓
          // 正答率の配列の最新5個を出力
          var resultYayoiOrder = resultYayoi.slice(-5);
          var resultAsukaOrder = resultAsuka.slice(-5);
          var resultNaraOrder = resultNara.slice(-5);

          // 弥生時代を表に入れる
          document.getElementById('Y1').textContent = resultYayoiOrder[4];
          document.getElementById('Y2').textContent = resultYayoiOrder[3];
          document.getElementById('Y3').textContent = resultYayoiOrder[2];
          document.getElementById('Y4').textContent = resultYayoiOrder[1];
          document.getElementById('Y5').textContent = resultYayoiOrder[0];
          
          // 飛鳥時代を表に入れる
          document.getElementById('A1').textContent = resultAsukaOrder[4];
          document.getElementById('A2').textContent = resultAsukaOrder[3];
          document.getElementById('A3').textContent = resultAsukaOrder[2];
          document.getElementById('A4').textContent = resultAsukaOrder[1];
          document.getElementById('A5').textContent = resultAsukaOrder[0];

          // 奈良時代を表に入れる
          document.getElementById('N1').textContent = resultNaraOrder[4];
          document.getElementById('N2').textContent = resultNaraOrder[3];
          document.getElementById('N3').textContent = resultNaraOrder[2];
          document.getElementById('N4').textContent = resultNaraOrder[1];
          document.getElementById('N5').textContent = resultNaraOrder[0];
          // 各時代の実施回ごとの正答率を出す処理↑
        })
        .catch(function(err){
          console.log("テスト結果を取得できませんでした");
        });


      } 

    });

    if (ons.platform.isIPhoneX()) {
      document.documentElement.setAttribute('onsflag-iphonex-portrait', '');
      document.documentElement.setAttribute('onsflag-iphonex-landscape', '');
    }
  </script>
</head>
<body>
  <ons-navigator id="navigator" page="score-top.html"></ons-navigator>

  <ons-template id="score-top.html">
    <ons-page id="score-top-page"  class="top">
  
      <ons-toolbar>
        <div class="center">これまでの成績</div>
      </ons-toolbar>
  
      <table>
        <thead>
          <tr>
            <th></th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>累計</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th>弥生</th>
            <td><span id="Y1"></span>%</td>
            <td><span id="Y2"></span>%</td>
            <td><span id="Y3"></span>%</td>
            <td><span id="Y4"></span>%</td>
            <td><span id="Y5"></span>%</td>
            <td><span id="yAvg"></span>%</td>
          </tr>
          <tr>
            <th>飛鳥</th>
            <td><span id="A1"></span>%</td>
            <td><span id="A2"></span>%</td>
            <td><span id="A3"></span>%</td>
            <td><span id="A4"></span>%</td>
            <td><span id="A5"></span>%</td>
            <td><span id="aAvg"></span>%</td>
          </tr>
          <tr>
            <th>奈良</th>
            <td><span id="N1"></span>%</td>
            <td><span id="N2"></span>%</td>
            <td><span id="N3"></span>%</td>
            <td><span id="N4"></span>%</td>
            <td><span id="N5"></span>%</td>
            <td><span id="nAvg"></span>%</td>
          </tr>
        </tbody>
      </table>
  
      <footer>
        <a href="index.html" class="top-btn btn">TOPへ戻る</a>
      </footer>
    </ons-page>
  
   </ons-template>
</body>
</html>