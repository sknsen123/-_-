<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <!-- <script src="js/app.js"></script> -->
  <script src="lib/onsenui/js/onsenui.min.js"></script>

  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="css/history.js"></script>

  <script type="module">
    // Page init event

    if (ons.platform.isIPhoneX()) {
      document.documentElement.setAttribute('onsflag-iphonex-portrait', '');
      document.documentElement.setAttribute('onsflag-iphonex-landscape', '');
    }

    document.addEventListener('init', function(event) {
      var page = event.target;

      // ☆学習モード選択画面にいるとき
      if (page.matches('#pra-top-page')) {
        page.querySelector('#pra-start').onclick = function() {
          document.querySelector('#navigator').pushPage('pra.html');
        }
      }
      
      // ☆問題を解く画面に来たとき
      else if (page.matches('#pra-page')) {

        // ☆セレクトボックスで選択した値を取得する
        const questionNum = document.getElementById("questionNum").value;
        const format = document.getElementById("format").value;
        const range = document.getElementById("range").value;

        console.log(questionNum, format, range);

        // 下にずらずら条件分岐を書きます
        // 長すぎるのでまとめたいー…。
        // 携帯で表示されないのはなぜ？
        // 配列のフィルタリング参考「http://lifelog.main.jp/wordpress/?p=2557」
        // ☆全問題から出題
        if (format === "all-era") {
          const findEra = history.filter(function(element) {
            return element.時代;
          });
          console.log(findEra); 
          // ↑これで取得してるのは配列
          
          // 全時代からやるなら順番に出題を選択できないようにしてランダムのみ選択できるようにしたい
          if (range === "orderBy") {
            if (questionNum === "10") {
              var question = findEra.slice(0, 10);
              console.log(question);
            } 
            else if (questionNum === "30") {
              var question = findEra.slice(0, 30);
              console.log(question);
            } 
            else if (questionNum === "50") {
              var question = findEra.slice(0, 50);
              console.log(question);
            }
          } 
          
          else if (range === "random") {
            // ドットインストールのフィッシャー・イェーツのアルゴリズムのコード
            // ⇒解説「https://qiita.com/may88seiji/items/69d5b05dff2c9d059155」
            const shuffledObj = ([...findEra]) => {
              for (let i = findEra.length - 1; i >= 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [findEra[i], findEra[j]] = [findEra[j], findEra[i]]
              }
              return findEra;
            }
            // フィッシャー・イェーツのアルゴリズム、表示参考「https://www.nxworld.net/tips/js-array-shuffle.html」
            console.log(shuffledObj(findEra)); 
            // ↑このshuffleObj(findEra)って何を指してるんだ？

            // ☆指定された問題数を配列で抜き取る
            // ①10問
            if (questionNum === "10") {
              var question = shuffledObj(findEra).slice(0, 10);
              console.log(question);
            } 
            // ②30問
            else if (questionNum === "30") {
              var question = shuffledObj(findEra).slice(0, 30);
              console.log(question);
            } 
            // ③50問
            else if (questionNum === "50") {
              var question = shuffledObj(findEra).slice(0, 50);
              console.log(question);
            }
          }
        }

        // ☆時代別…弥生
        else if (format === "yayoi-era") {
          const findEra = history.filter(function(element) {
            return element.時代 === "弥生";
          });
          console.log(findEra);

          if (range === "orderBy") {
            if (questionNum === "10" || "30" || "50") {
              var question = findEra.slice(0, 10);
              console.log(question);
            } 
          } else if (range === "random") {
            const shuffledObj = ([...findEra]) => {
              for (let i = findEra.length - 1; i >= 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [findEra[i], findEra[j]] = [findEra[j], findEra[i]]
              }
              return findEra;
            }
            console.log(shuffledObj(findEra)); 

            if (questionNum === "10" || "30" || "50") {
              var question = shuffledObj(findEra).slice(0, 10);
              console.log(question);
            } 
          }
        } 

        // ☆時代別…飛鳥
        else if (format === "asuka-era") {
          const findEra = history.filter(function(element) {
            return element.時代 === "飛鳥";
          });
          console.log(findEra);

          if (range === "orderBy") {
            if (questionNum === "10" || "30" || "50") {
              var question = findEra.slice(0, 10);
              console.log(question);
            } 
          } else if (range === "random") {
            const shuffledObj = ([...findEra]) => {
              for (let i = findEra.length - 1; i >= 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [findEra[i], findEra[j]] = [findEra[j], findEra[i]]
              }
              return findEra;
            }
            console.log(shuffledObj(findEra)); 

            if (questionNum === "10" || "30" || "50") {
              var question = shuffledObj(findEra).slice(0, 10);
              console.log(question);
            } 
          }
        } 

        // ☆時代別…奈良
        else if (format === "nara-era") {
          const findEra = history.filter(function(element) {
            return element.時代 === "奈良";
          });
          console.log(findEra);

          if (range === "orderBy") {
            if (questionNum === "10" || "30" || "50") {
              var question = findEra.slice(0, 10);
              console.log(question);
            } 
          } else if (range === "random") {
            const shuffledObj = ([...findEra]) => {
              for (let i = findEra.length - 1; i >= 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [findEra[i], findEra[j]] = [findEra[j], findEra[i]]
              }
              return findEra;
            }
            console.log(shuffledObj(findEra)); 

            if (questionNum === "10" || "30" || "50") {
              var question = shuffledObj(findEra).slice(0, 10);
              console.log(question);
            } 
          }
        }

        page.querySelector('#pra-top-btn').onclick = function() {
          document.querySelector('#navigator').popPage();
          // ↓処理を消す？なかったことにする？ための命令をここに
        }
      }

      // ☆ひな形に入れ込んでいく部分
      if (page.matches('#pra-page')) {
        const praPic = document.getElementById('praPic');
        const praExplanation = document.getElementById('praExplanation');
        let i = 0;
        let score = 0;
        var wrongAnswer = [];
        function nextQuestion() {
          // ↓inputの中身を消去
          var answerForm = document.getElementById("answer");
          answerForm.value = '';

          // 最後の問題だったら結果画面に遷移させる処理
          if (i === question.length - 1) {
            document.querySelector("#ans-btn").onclick = function() {
              document.querySelector('#navigator').pushPage('pra-score.html');
            };
          }
          
          i += 1;
          praPic.src = question[i].画像;
          praExplanation.textContent = question[i].内容;

          document.getElementById('ans-btn').disabled = true;
        }

        praPic.src = question[i].画像;
        praExplanation.textContent = question[i].内容;

        // 1文字以上入力しないとボタンが押せないようにする処理
        document.getElementById('ans-btn').disabled = true;
        document.getElementById('answer').addEventListener('keyup', function() {
          if (this.value.length < 1) {
            document.getElementById('ans-btn').disabled = true;
          } else {
            document.getElementById('ans-btn').disabled = false;
          }
        });

        // クリックしたら次の問題が表示されるようにしている
        document.getElementById('ans-btn').addEventListener('click', () => {
          const answer = document.getElementById("answer").value;
          
          // ☆正誤判定
          if (String(answer) === question[i].年号) {
            // 何問正解かだけでいいので情報を保持して、結果表示のところで数字を使う
            // できれば〇！とか×！の画像を表示したい

            // ◎仏教伝来、538か552のどちらかを入れたらOKということにしないと使い物にならんこれ
            score++;
          } else {
            // 間違えた問題を保持するため、空の配列を用意して間違えたやつを入れていく
            wrongAnswer.push(question[i]);
          }
          console.log(wrongAnswer, score);
          
          // 1秒後に次の問題へ進める
          setTimeout(() => {
            nextQuestion();
          }, 1000);
          
        });   
      }

    });

  </script>
</head>
<body>
  <ons-navigator id="navigator" page="pra-top.html"></ons-navigator>

  <ons-template id="pra-top.html">
    <ons-page id="pra-top-page" class="practice">
      <ons-toolbar>
        <div class="center">演習モード・モード選択</div>
      </ons-toolbar>
  
      <img src="css/picture/ヘタリア_プロイセン.jpg" height="200">
    
      <!-- 「https://itsakura.com/js-selectbox」selectボックスの値の習得の仕方。役立ちそう -->
      <p>問題数</p>
      <ons-form>
        <ons-select id="questionNum">
          <option value="10">10問</option>
          <option value="30">30問</option>
          <option value="50">50問</option>
        </ons-select>
      </ons-form>
  
      <p>出題範囲</p>
      <ons-form>
        <ons-select id="format">
          <option value="all-era">全ての範囲から出題</option>
          <option value="yayoi-era">弥生時代から出題</option>
          <option value="asuka-era">飛鳥時代から出題</option>
          <option value="nara-era">奈良時代から出題</option>
        </ons-select>
      </ons-form>
  
      <p>出題形式</p>
      <ons-form>
        <ons-select id="range">
          <option value="orderBy">順番に出題</option>
          <option value="random">ランダムに出題</option>
        </ons-select>
      </ons-form>
  
      <footer>
        <ons-button id="pra-start">スタート</ons-button>
        <br>
        <a href="index.html">TOPへ戻る</a>
      </footer>
    </ons-page>
  </ons-template>

  <!-- 練習ページ（問題）ひな形 -->
  <ons-template id="pra.html">
    <ons-page id="pra-page">
      <ons-toolbar>
        <!-- ↓インデックス番号 + 1 で表せそうかな？ -->
        <div class="center">第<span id=qNum></span>問</div>
      </ons-toolbar>
  
      <!-- オブジェクトに合わせて配列historyの画像部分が表示されるようにする -->
      <img id="praPic" height="200">
  
      <p id="praExplanation"></p>
  
      <!-- ons-inputよく分かっていないので必要になったらちゃんと見る -->
      <p>
        <ons-input id="answer" name="answer" type="number" value="" modifier="underbar" placeholder="年号を入力" autocomplete="off" float>入力欄</ons-input>
      </p>
  
      <footer>
        <ons-button id="ans-btn" onclick="disabled = true;" disabled>解答する</ons-button>
        <ons-button id="pra-top-btn">練習モードTOPへ戻る</ons-button>
      </footer>
  
    </ons-page>
  </ons-template>

  <!-- 結果表示ページ ひな形 -->
  <ons-template id="pra-score.html">
    <ons-page id="pra-score-page">
      <ons-toolbar>
        <!-- ↓インデックス番号 + 1 で表せそうかな？ -->
        <div class="center">結果</div>
      </ons-toolbar>
  
      <!-- オブジェクトに合わせて配列historyの画像部分が表示されるようにする -->
      <p id="pra-score">〇問中〇問正解！！！</p>
  
      <div id="pra-score-explanation">解説
        <img id="praScorePic" height="200">
        <p id="praScoreNengo">年号</p>
        <p id="praScoreExplanation">内容</p>
        <p id="praScoreYuru">ゆる説明</p>
      </div>
  
      <footer>
        <ons-button id="pra-top-btn">練習モードTOPへ戻る</ons-button>
      </footer>
  
    </ons-page>
  </ons-template>

</body>
</html>